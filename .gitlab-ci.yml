# image: ruby:2.3
image: xkumiyu/ruby-firefox

services:
  # - mysql:latest
  # - postgres:latest

variables:
  HEROKU_DEBELOPMENT_API_KEY: 74f0308d-1b82-4ebd-9cdf-4cd7017118ec
  HEROKU_STAGING_API_KEY: 74f0308d-1b82-4ebd-9cdf-4cd7017118ec
  HEROKU_PRODUCTION_API_KEY: 74f0308d-1b82-4ebd-9cdf-4cd7017118ec

before_script:
  - ruby -v
  - cp config/secrets.yml.example config/secrets.yml
  - gem install bundler --no-ri --no-rdoc
  - bundle install --path vendor/bundle
  - RAILS_ENV=test bundle exec rake db:drop db:create db:schema:load db:migrate

stages:
  - test
  - deploy

spec:controllers:
  stage: test
  script:
    - RAILS_ENV=test bundle exec rake spec:controllers
  tags:
    - ruby

spec:models:
  stage: test
  script:
    - RAILS_ENV=test bundle exec rake spec:models
  tags:
    - ruby

spec:requests:
  stage: test
  script:
    - RAILS_ENV=test bundle exec rake spec:requests
  tags:
    - ruby

spec:features:
  stage: test
  script:
    - Xvfb :99 -screen 0 1024x768x24 &
    # - firefox &
    - RAILS_ENV=test bundle exec rake spec:features
  tags:
    - ruby

rubocop:
  stage: test
  script:
    - bundle exec rubocop -D
  tags:
    - ruby

brakeman:
  stage: test
  script:
    - bundle exec brakeman
  tags:
    - ruby

deploy:development:
  stage: deploy
  script:
    - gem install dpl
    - dpl --provider=heroku --app=meetil-devlopment --api-key=$HEROKU_DEBELOPMENT_API_KEY
  only:
    - develop
  tags:
    - ruby

deploy:staging:
  stage: deploy
  script:
    - gem install dpl
    - dpl --provider=heroku --app=meetil-staging --api-key=$HEROKU_STAGING_API_KEY
  only:
    - release
  tags:
    - ruby

deploy:production:
  stage: deploy
  script:
    - gem install dpl
    - dpl --provider=heroku --app=meetil-production --api-key=$HEROKU_PRODUCTION_API_KEY
  only:
    - master
  tags:
    - ruby
